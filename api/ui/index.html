<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>nock files</title>
<style>
  /* ultra-stark */
  body { font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:20px auto; max-width:900px; color:#111; background:#fff; }
  h2 { margin:0; font-size:18px; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  input, button { font:inherit; border:1px solid #ccc; padding:4px 6px; background:#fff; color:#111; }
  input[type=file]{ padding:0; }
  button { cursor:pointer; }
  #msg { font-size:13px; margin:4px 0 10px; white-space:pre-wrap; color:#444; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th, td { border-bottom:1px solid #ddd; padding:6px 6px; text-align:left; }
  td.name { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  td.size, td.time { white-space:nowrap; }
  footer { margin-top:12px; font-size:12px; color:#666; }
  .hidden { display:none; }
  .invalid { outline:1px solid #c33; }
  .meta { font-size:13px; color:#444; margin:6px 0 0; }
  .meta code { background:#f7f7f7; padding:2px 4px; border:1px solid #e5e5e5; }
  .actions button { margin-right:6px; }
</style>
</head>
<body>

<!-- SOFT GATE -->
<section id="gate">
  <div class="row"><h2 style="flex:1">nock files</h2></div>
  <div class="row">
    <input id="gateToken" type="password" placeholder="token" style="flex:1" />
    <button id="gateBtn">Enter</button>
  </div>
  <div id="gateMsg" style="font-size:13px;margin-top:6px;"></div>
</section>

<!-- APP -->
<section id="app" class="hidden">

  <br />

  <section style="margin-bottom:16px">
    <details>
      <summary style="cursor:pointer;font-weight:600">Docs</summary>
      <pre style="margin-top:8px;padding:10px;background:#f7f7f7;border:1px solid #ddd;border-radius:4px;overflow-x:auto;font-size:13px;line-height:1.4">
    <code>
    # Hello world
    curl -sS "https://api.nock.ezpz.sh/pub/gm"

    # List public files
    curl -sS "https://api.nock.ezpz.sh/ls?prefix=pub/" | jq .

    # Download a public file
    curl -o latest.jam "https://api.nock.ezpz.sh/pub/file.txt"

    # Download a private file (requires authentication)
    curl -o file.txt "https://api.nock.ezpz.sh/priv/dir/file.txt"

    # Upload a private file (requires authentication)
    curl -sST file.txt "https://api.nock.ezpz.sh/priv/writable/file.txt"

    # Check permissions
    curl -sS "https://api.nock.ezpz.sh/auth/verify" | jq .

    # Endpoints that require authentication may use either header:
      -H "Authorization: Bearer YOUR_TOKEN"
    # or query parameter:
      ?key=YOUR_TOKEN
    </code>
      </pre>
    </details>
  </section>

  <br />

  <section>
    <details>
      <summary style="cursor:pointer;font-weight:600">Upload</summary>
      <div class="row" style="margin-top:4px">
        <input id="uploadPath" style="flex:1" placeholder="priv/…/file.txt" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
      <div id="writable" class="meta"></div>
    </details>
  </section>

  <br />
  <br />

  <section>
    <div id="msg"></div>
    <table>
      <thead>
        <tr>
          <th class="name">File</th>
          <th class="size">Size</th>
          <th class="time">Uploaded</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</section>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = id => document.getElementById(id);

const state = { prefixes: [], writePrefixes: [] };

/* ---------- token + gate ---------- */
const getToken = () => (localStorage.getItem('token') || '').trim();
const setToken = (t) => localStorage.setItem('token', (t||'').trim());

async function verifyToken(t){
  const res = await fetch(`${API}/auth/verify`, { headers: t ? { Authorization: 'Bearer ' + t } : {} });
  if (!res.ok) return null;
  try { return await res.json(); } catch { return null; } // { roles, prefixes, writePrefixes }
}

function authHeaders(){ const t=getToken(); return t ? { Authorization: 'Bearer ' + t } : {}; }
function normPrefix(p){ return p && !p.endsWith('/') ? p + '/' : p; }
function setMsg(txt, ok=true){ const el=$('msg'); el.textContent = txt || ''; el.style.color = ok ? '#444' : '#c33'; }
function canWriteKey(key) { return (state.writePrefixes || []).some(pref => key.startsWith(pref)); }

/* human-readable sizes: 3b, 3kb, 3mb, 3gb, 3tb */
function fmtSize(bytes){
  if (bytes == null) return '';
  const u = ['b','kb','mb','gb','tb'];
  let i = 0; let n = Math.max(0, Number(bytes));
  while (n >= 1024 && i < u.length - 1) { n /= 1024; i++; }
  const val = n >= 10 || i === 0 ? Math.round(n) : Math.round(n * 10) / 10;
  return `${val}${u[i]}`;
}

async function listAll(prefixes){
  const reqs = (prefixes || []).map(p => {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', normPrefix(p));
    return fetch(url, { headers: authHeaders() }).then(async r => {
      if (!r.ok) throw new Error(`ls ${p} → ${r.status}`);
      return r.json(); // { prefix, objects }
    });
  });
  const results = await Promise.all(reqs);
  const objects = results.flatMap(r => r.objects || []);
  objects.sort((a,b) => a.key.localeCompare(b.key));
  return objects;
}

function buildGetHref(key, token) {
  if (key.startsWith('pub/')) {
    const rel = key.slice('pub/'.length);
    return `${API}/pub/${rel.split('/').map(encodeURIComponent).join('/')}`;
  }
  if (key.startsWith('priv/')) {
    const rel = key.slice('priv/'.length);
    return `${API}/priv/${rel.split('/').map(encodeURIComponent).join('/')}?key=${encodeURIComponent(token)}`;
  }
  return `${API}/priv/${key.split('/').map(encodeURIComponent).join('/')}?key=${encodeURIComponent(token)}`;
}

function renderWritable() {
  const el = $('writable');
  const list = state.writePrefixes || [];
  if (!list.length) { el.textContent = 'Writable: none'; return; }
  el.innerHTML = `Writable: ${list.map(p => `<code>${p}</code>`).join(' ')}`;
  if (!$('uploadPath').value) $('uploadPath').placeholder = `${list[0]}file.txt`;
}

function renderTable(objects){
  const rows = $('rows'); rows.innerHTML = '';
  const token = getToken();
  if (!objects.length) { setMsg('No files.'); return; }
  setMsg('');
  for (const o of objects) {
    const full = o.key;
    const href = buildGetHref(full, token);
    const delAllowed = full.startsWith('priv/') && canWriteKey(full);

    rows.insertAdjacentHTML('beforeend',
      `<tr>
        <td class="name">${full}</td>
        <td class="size">${fmtSize(o.size)}</td>
        <td class="time">${new Date(o.uploaded).toLocaleString()}</td>
        <td class="actions">
          <button type="button" data-get="${encodeURIComponent(full)}">GET</button>
          ${delAllowed ? `<button type="button" data-del="${encodeURIComponent(full)}">DEL</button>` : ''}
        </td>
      </tr>`);

    // Wire per-row GET immediately to avoid later querySelectorAll passes
    const lastRow = rows.lastElementChild;
    const getBtn = lastRow.querySelector('button[data-get]');
    getBtn.onclick = () => {
      // open in new tab for priv (keeps token out of referrer); same tab for pub
      const isPriv = full.startsWith('priv/');
      const url = buildGetHref(full, token);
      window.open(url, isPriv ? '_blank' : '_self');
    };

    if (delAllowed) {
      const delBtn = lastRow.querySelector('button[data-del]');
      delBtn.onclick = async () => {
        if (!confirm('Delete ' + full + '?')) return;
        const path = full.replace(/^priv\//, '');
        const enc = path.split('/').map(encodeURIComponent).join('/');
        const resDel = await fetch(`${API}/priv/${enc}`, { method:'DELETE', headers: authHeaders() });
        if (!resDel.ok) setMsg('Delete failed: ' + (await resDel.text()), false);
        else refreshListing(); // refresh after delete
      };
    }
  }
}

async function refreshListing(){
  try {
    const objs = await listAll(state.prefixes);
    renderTable(objs);
  } catch (e) {
    setMsg('List error: ' + (e?.message || e), false);
  }
}

async function enterWithToken(t){
  const info = await verifyToken(t);
  if (!info) return false;
  setToken(t);
  state.prefixes = info.prefixes || [];
  state.writePrefixes = info.writePrefixes || [];
  $('gate').classList.add('hidden');
  $('app').classList.remove('hidden');
  renderWritable();
  await refreshListing();
  return true;
}

$('gateBtn').onclick = async () => {
  const t = $('gateToken').value.trim();
  const ok = await enterWithToken(t);
  $('gateToken').classList.toggle('invalid', !ok);
  $('gateMsg').textContent = ok ? '' : 'Invalid token';
};

// auto-try saved token
(async () => {
  const saved = getToken();
  if (saved) await enterWithToken(saved);
})();

/* ---------- upload (refresh on success) ---------- */
$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.replace(/^priv\//, '');
  try {
    const enc = rel.split('/').map(encodeURIComponent).join('/');
    const res = await fetch(`${API}/priv/${enc}`, {
      method:'PUT',
      body:file,
      headers:{ ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else {
      setMsg('Uploaded');
      await refreshListing(); // refresh after upload
    }
  } catch(e) { setMsg('Upload error: ' + (e?.message || e), false); }
};
</script>
</body>
</html>
