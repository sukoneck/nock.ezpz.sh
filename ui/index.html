<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nock files</title>
  <style>
    :root { --w: 860px; --gap: 10px; --pad: 14px; --radius: 8px; }
    /* Base */
    html,body { margin:0; padding:0; }
    body {
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #111; background:#fff;
      max-width: var(--w); margin: 28px auto; padding: 0 14px;
    }
    h2 { margin:0; font-size:18px; }
    small, code { color:#666; }
    /* Layout */
    .row { display:flex; gap: var(--gap); align-items:center; }
    header.row { margin-bottom: 14px; }
    nav.row { margin: 8px 0 16px; }
    /* Controls */
    input[type="text"], input[type="password"], input[type="file"], button {
      font: inherit; color: inherit; background:#fff;
      border:1px solid #ccc; border-radius: var(--radius);
      height: 34px; padding: 0 10px;
    }
    input[type="file"] { padding: 6px; height:auto; }
    button { cursor:pointer; }
    button:hover { background:#f7f7f7; }
    /* Messages */
    #msg { white-space: pre-wrap; font-size:13px; color:#666; margin:6px 0 12px; }
    /* Table */
    table { width:100%; border-collapse: collapse; }
    thead th { text-align:left; font-weight:600; font-size:13px; color:#444; border-bottom:1px solid #ddd; padding:8px 6px; position:sticky; top:0; background:#fff; }
    tbody td { border-bottom:1px solid #eee; padding:8px 6px; vertical-align:middle; }
    tbody tr:hover { background:#fafafa; }
    td.name { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    td.size, td.time { white-space: nowrap; color:#444; }
    td.actions a, td.actions button { font: inherit; }
    td.actions a { color:#06c; text-decoration:none; border-bottom:1px dotted #06c; }
    td.actions a:hover { text-decoration:underline; border-bottom-color:transparent; }
    td.actions button { padding: 4px 8px; border-radius:6px; }
    footer { margin-top: 16px; }
    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      body { color:#eaeaea; background:#0b0b0b; }
      small, code, #msg { color:#aaa; }
      input, button { background:#111; border-color:#333; color:#eaeaea; }
      button:hover { background:#161616; }
      thead th { background:#0b0b0b; border-bottom-color:#222; color:#bbb; }
      tbody td { border-bottom-color:#1a1a1a; }
      tbody tr:hover { background:#111; }
      td.actions a { color:#7fb3ff; border-bottom-color:#7fb3ff; }
    }
  </style>
</head>
<body>
  <header class="row">
    <h2 style="flex:1">nock files</h2>
    <input id="token" type="password" placeholder="optional token" />
    <button id="saveToken">Save</button>
  </header>

  <nav class="row">
    <input id="prefix" style="flex:1" placeholder="pub" />
    <button id="listBtn">List</button>
  </nav>

  <article>
    <details open>
      <summary>Upload</summary>
      <div class="row" style="margin-top:8px">
        <input id="uploadPath" placeholder="priv/team-a/file.txt" style="flex:1" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
    </details>
  </article>

  <article>
    <h4 style="margin:16px 0 6px">Contents</h4>
    <div id="msg"></div>
    <table>
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="size">Size</th>
          <th class="time">Uploaded</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </article>

  <footer>
    <small>API: <code>https://api.nock.ezpz.sh</code></small>
  </footer>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = (id) => document.getElementById(id);

// Token persistence
(() => { $('token').value = localStorage.getItem('token') || ''; })();
$('saveToken').onclick = () => localStorage.setItem('token', $('token').value.trim());

function authHeaders() {
  const t = $('token').value.trim();
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}

function normPrefix(p) { if (!p) return p; if (!p.endsWith('/')) p += '/'; return p; }

function setMsg(text, ok=true) {
  const el = $('msg'); el.textContent = text || ''; el.style.color = ok ? '' : '#c33';
}

$('listBtn').onclick = async () => {
  let prefix = normPrefix($('prefix').value.trim());
  if (!prefix) { alert('Enter a prefix'); return; }
  try {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', prefix.replace(/^pub\//, 'pub/').replace(/^priv\//, 'priv/'));
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) { setMsg(`List failed (status ${res.status}).\n${await res.text()}`, false); return; }
    const data = await res.json();
    const rows = $('rows'); rows.innerHTML = ''; setMsg('');

    for (const d of data.directories) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="name"><strong>${d}</strong></td><td></td><td></td><td></td>`;
      rows.appendChild(tr);
    }
    for (const o of data.objects) {
      const rel   = o.key.startsWith(prefix) ? o.key.slice(prefix.length) : o.key;
      const isPub = prefix.startsWith('pub/');
      const token = $('token').value.trim();
      const encoded = rel.split('/').map(encodeURIComponent).join('/');
      const getHref = isPub
        ? `${API}/pub/${encoded}`
        : `${API}/priv/${encoded}?key=${encodeURIComponent(token)}`;
      const a   = `<a href="${getHref}" ${isPub ? '' : 'target="_blank" rel="noopener"'}>GET</a>`;
      const del = isPub ? '' : ` <button data-key="${o.key}">DEL</button>`;
      const tr  = document.createElement('tr');
      tr.innerHTML = `
        <td class="name">${rel}</td>
        <td class="size">${o.size}</td>
        <td class="time">${new Date(o.uploaded).toLocaleString()}</td>
        <td class="actions">${a}${del}</td>`;
      rows.appendChild(tr);
    }

    // Wire delete buttons (priv only)
    document.querySelectorAll('button[data-key]').forEach(btn => btn.onclick = async () => {
      const key = btn.getAttribute('data-key');
      if (!confirm('Delete ' + key + '?')) return;
      const path = key.startsWith('priv/') ? key.slice('priv/'.length) : key;
      const encodedPath = path.split('/').map(encodeURIComponent).join('/');
      const res = await fetch(`${API}/priv/${encodedPath}`, { method:'DELETE', headers: authHeaders() });
      if (!res.ok) setMsg('Delete failed: ' + (await res.text()), false);
      else $('listBtn').click();
    });
  } catch (e) { setMsg('List error: ' + (e?.message || e), false); }
};

$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.startsWith('priv/') ? target.slice('priv/'.length) : target;
  try {
    const res = await fetch(`${API}/priv/${rel.split('/').map(encodeURIComponent).join('/')}`, {
      method: 'PUT', body: file, headers: { ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else setMsg('Uploaded');
  } catch (e) { setMsg('Upload error: ' + (e?.message || e), false); }
};
</script>
</body>
</html>
