<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>nock files</title>
<style>
  /* ultra-stark */
  body { font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:20px auto; max-width:800px; }
  h2 { margin:0; font-size:18px; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  input, button { font:inherit; border:1px solid #ccc; padding:4px 6px; }
  input[type=file]{ padding:0; }
  #msg { font-size:13px; margin:4px 0 10px; white-space:pre-wrap; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th, td { border-bottom:1px solid #ddd; padding:4px 6px; text-align:left; }
  td.name { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  td.size, td.time { white-space:nowrap; }
  td.actions a { color:#06c; text-decoration:none; }
  td.actions a:hover { text-decoration:underline; }
  footer { margin-top:12px; font-size:12px; color:#666; }
  .hidden { display:none; }
  .invalid { outline:1px solid #c33; }
  @media (prefers-color-scheme: dark){
    body{ background:#000; color:#eee; }
    input,button{ background:#000; color:#eee; border-color:#555; }
    th,td{ border-color:#333; }
    td.actions a{ color:#7fb3ff; }
    footer{ color:#aaa; }
  }
</style>
</head>
<body>

<!-- SOFT GATE: shown first; only token field visible -->
<section id="gate">
  <div class="row">
    <h2 style="flex:1">nock files</h2>
  </div>
  <div class="row">
    <input id="gateToken" type="password" placeholder="token" style="flex:1" />
    <button id="gateBtn">Enter</button>
  </div>
  <div id="gateMsg" style="font-size:13px;color:#666;margin-top:6px;"></div>
</section>

<!-- APP: hidden until token verifies -->
<section id="app" class="hidden">
  <nav class="row">
    <input id="prefix" style="flex:1" placeholder="pub" />
    <button id="listBtn">List</button>
  </nav>

  <section>
    <details open>
      <summary>Upload</summary>
      <div class="row" style="margin-top:4px">
        <input id="uploadPath" style="flex:1" placeholder="priv/team-a/file.txt" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
    </details>
  </section>

  <section>
    <h4>Contents</h4>
    <div id="msg"></div>
    <table>
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="size">Size</th>
          <th class="time">Uploaded</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <footer>
    API: <code>https://api.nock.ezpz.sh</code>
  </footer>
</section>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = id => document.getElementById(id);

/* ---------- token + gate ---------- */
function getToken(){ return (localStorage.getItem('token') || '').trim(); }
function setToken(t){ localStorage.setItem('token', (t||'').trim()); }

async function verifyToken(t){
  const res = await fetch(`${API}/auth/verify`, { headers: t ? { Authorization: 'Bearer ' + t } : {} });
  if (!res.ok) return null;
  try { const data = await res.json(); return data.roles || []; } catch { return null; }
}

async function enterWithToken(t){
  const roles = await verifyToken(t);
  if (!roles) return false;
  setToken(t);
  $('gate').classList.add('hidden');
  $('app').classList.remove('hidden');
  return true;
}

$('gateBtn').onclick = async () => {
  const t = $('gateToken').value.trim();
  const ok = await enterWithToken(t);
  $('gateToken').classList.toggle('invalid', !ok);
  $('gateMsg').textContent = ok ? '' : 'Invalid token';
};

// auto-try saved token
(async () => {
  const saved = getToken();
  if (saved) await enterWithToken(saved);
})();

/* ---------- app helpers ---------- */
function authHeaders(){ const t=getToken(); return t ? { Authorization: 'Bearer ' + t } : {}; }
function normPrefix(p){ return p && !p.endsWith('/') ? p + '/' : p; }
function setMsg(txt, ok=true){ const el=$('msg'); el.textContent = txt || ''; el.style.color = ok ? '' : '#c33'; }

/* ---------- list ---------- */
$('listBtn').onclick = async () => {
  let prefix = normPrefix($('prefix').value.trim());
  if (!prefix) { alert('Enter a prefix'); return; }
  try {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', prefix);
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) { setMsg(`List failed (${res.status}):\n${await res.text()}`, false); return; }
    const data = await res.json();
    const rows = $('rows'); rows.innerHTML = ''; setMsg('');

    for (const d of data.directories) {
      rows.insertAdjacentHTML('beforeend',
        `<tr><td class="name"><strong>${d}</strong></td><td></td><td></td><td></td></tr>`);
    }

    for (const o of data.objects) {
      const rel   = o.key.startsWith(prefix) ? o.key.slice(prefix.length) : o.key; // display only
      const isPub = prefix.startsWith('pub/');
      const token = getToken();

      // For download: preserve full key for priv (don't drop path parts)
      const dlKey = isPub
        ? rel // public: rel is fine
        : o.key.replace(/^priv\//, ''); // private: keep full path after 'priv/'

      const encDlKey = dlKey.split('/').map(encodeURIComponent).join('/');

      const getHref = isPub
        ? `${API}/pub/${encDlKey}`
        : `${API}/priv/${encDlKey}?key=${encodeURIComponent(token)}`;

      const a   = `<a href="${getHref}" ${isPub ? '' : 'target="_blank"'}>GET</a>`;
      const del = isPub ? '' : ` <button data-key="${o.key}">DEL</button>`;

      rows.insertAdjacentHTML('beforeend',
        `<tr><td class="name">${rel}</td><td class="size">${o.size}</td><td class="time">${new Date(o.uploaded).toLocaleString()}</td><td class="actions">${a}${del}</td></tr>`);
    }

    // delete (priv only)
    document.querySelectorAll('button[data-key]').forEach(btn => btn.onclick = async () => {
      if (!confirm('Delete ' + btn.dataset.key + '?')) return;
      const path = btn.dataset.key.replace(/^priv\//, '');
      const enc = path.split('/').map(encodeURIComponent).join('/');
      const resDel = await fetch(`${API}/priv/${enc}`, { method:'DELETE', headers: authHeaders() });
      if (!resDel.ok) setMsg('Delete failed: ' + (await resDel.text()), false);
      else $('listBtn').click();
    });
  } catch(e) { setMsg('List error: ' + (e?.message || e), false); }
};

/* ---------- upload ---------- */
$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.replace(/^priv\//, '');
  try {
    const enc = rel.split('/').map(encodeURIComponent).join('/');
    const res = await fetch(`${API}/priv/${enc}`, {
      method:'PUT',
      body:file,
      headers:{ ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else setMsg('Uploaded');
  } catch(e) { setMsg('Upload error: ' + (e?.message || e), false); }
};
</script>
</body>
</html>
