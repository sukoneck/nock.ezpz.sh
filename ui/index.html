<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nock files</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body { max-width: 1000px; margin: 2rem auto; }
    .row { display:flex; gap:1rem; align-items:center; }
    code { user-select: all; }
    #msg { white-space: pre-wrap; }
  </style>
</head>
<body>
  <header class="row">
    <h2 style="flex:1">nock files</h2>
    <input id="token" type="password" placeholder="optional token" />
    <button id="saveToken">Save</button>
  </header>

  <nav class="row">
    <input id="prefix" style="flex:1" placeholder="pub" />
    <button id="listBtn">List</button>
  </nav>

  <article>
    <details open>
      <summary>Upload</summary>
      <div class="row">
        <input id="uploadPath" placeholder="priv/team-a/file.txt" style="flex:1" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
    </details>
  </article>

  <article>
    <h4>Contents</h4>
    <div id="msg"></div>
    <table>
      <thead><tr><th>Name</th><th>Size</th><th>Uploaded</th><th>Actions</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </article>

  <footer>
    <small>API: <code>https://api.nock.ezpz.sh</code></small>
  </footer>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = (id) => document.getElementById(id);

// Token persistence
(function() {
  const t = localStorage.getItem('token') || '';
  $('token').value = t;
})();
$('saveToken').onclick = () => localStorage.setItem('token', $('token').value.trim());

function authHeaders() {
  const t = $('token').value.trim();
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}

function normPrefix(p) {
  if (!p) return p;
  if (!p.endsWith('/')) p += '/';
  return p;
}

function setMsg(text, ok=true) {
  const el = $('msg');
  el.textContent = text || '';
  el.style.color = ok ? 'inherit' : 'var(--del-color, #c00)';
}

$('listBtn').onclick = async () => {
  let prefix = normPrefix($('prefix').value.trim());
  if (!prefix) { alert('Enter a prefix'); return; }
  try {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', prefix.replace(/^pub\//, 'pub/').replace(/^priv\//, 'priv/'));
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) {
      const body = await res.text();
      setMsg(`List failed (status ${res.status}).
${body}`, false);
      return;
    }
    const data = await res.json();
    const rows = $('rows'); rows.innerHTML = '';
    setMsg('');

    for (const d of data.directories) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><strong>${d}</strong></td><td></td><td></td><td></td>`;
      rows.appendChild(tr);
    }
    for (const o of data.objects) {
      const rel   = o.key.startsWith(prefix) ? o.key.slice(prefix.length) : o.key;
      const isPub = prefix.startsWith('pub/');
      const token = $('token').value.trim();
      const getHref = isPub
        ? `${API}/pub/${encodeURIComponent(rel)}`
        : `${API}/priv/${encodeURIComponent(o.key.slice('priv/'.length))}?key=${encodeURIComponent(token)}`;
      const a   = `<a href="${getHref}" ${isPub ? '' : 'target="_blank" rel="noopener"'}>GET</a>`;
      const del = isPub ? '' : ` <button data-key="${o.key}">DEL</button>`; // only show delete for priv
      const tr  = document.createElement('tr');
      tr.innerHTML =
        `<td>${rel}</td><td>${o.size}</td><td>${new Date(o.uploaded).toLocaleString()}</td><td>${a}${del}</td>`;
      rows.appendChild(tr);
    }


    // Wire delete buttons (restricted only)
    document.querySelectorAll('button[data-key]').forEach(btn => btn.onclick = async () => {
      const key = btn.getAttribute('data-key');
      if (!confirm('Delete ' + key + '?')) return;
      const path = key.startsWith('priv/') ? key.slice('priv/'.length) : key;
      const res = await fetch(`${API}/priv/${encodeURIComponent(path)}`, { method:'DELETE', headers: authHeaders() });
      if (!res.ok) setMsg('Delete failed: ' + (await res.text()), false);
      else $('listBtn').click();
    });
  } catch (e) {
    setMsg('List error: ' + (e && e.message ? e.message : e), false);
  }
};

$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.startsWith('priv/') ? target.slice('priv/'.length) : target;
  try {
    const res = await fetch(`${API}/priv/${encodeURIComponent(rel)}`, {
      method: 'PUT', body: file, headers: { ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else setMsg('Uploaded');
  } catch (e) {
    setMsg('Upload error: ' + (e && e.message ? e.message : e), false);
  }
};
</script>
</body>
</html>
