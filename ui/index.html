<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>nock files</title>
<style>
  /* ultra-stark */
  body { font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:20px auto; max-width:800px; color:#111; background:#fff; }
  h2 { margin:0; font-size:18px; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  input, button { font:inherit; border:1px solid #ccc; padding:4px 6px; background:#fff; color:#111; }
  input[type=file]{ padding:0; }
  #msg { font-size:13px; margin:4px 0 10px; white-space:pre-wrap; color:#444; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  th, td { border-bottom:1px solid #ddd; padding:4px 6px; text-align:left; }
  td.name { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
  td.size, td.time { white-space:nowrap; }
  td.actions a { color:#06c; text-decoration:none; }
  td.actions a:hover { text-decoration:underline; }
  footer { margin-top:12px; font-size:12px; color:#666; }
  .hidden { display:none; }
  .invalid { outline:1px solid #c33; }
  /* prefix chips */
  .chips { display:flex; flex-wrap:wrap; gap:6px; margin:8px 0 12px; }
  .chip { border:1px solid #ccc; padding:4px 8px; border-radius:999px; background:#fafafa; cursor:pointer; }
  .chip:hover { background:#f2f2f2; }
</style>
</head>
<body>

<!-- SOFT GATE -->
<section id="gate">
  <div class="row"><h2 style="flex:1">nock files</h2></div>
  <div class="row">
    <input id="gateToken" type="password" placeholder="token" style="flex:1" />
    <button id="gateBtn">Enter</button>
  </div>
  <div id="gateMsg" style="font-size:13px;margin-top:6px;"></div>
</section>

<!-- APP -->
<section id="app" class="hidden">
  <div class="row">
    <input id="prefix" style="flex:1" placeholder="pub" />
    <button id="listBtn">List</button>
  </div>

  <div id="chipsWrap" class="hidden">
    <strong>Writable:</strong>
    <div id="chips" class="chips"></div>
  </div>

  <section>
    <details open>
      <summary>Upload</summary>
      <div class="row" style="margin-top:4px">
        <input id="uploadPath" style="flex:1" placeholder="priv/team-a/file.txt" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
    </details>
  </section>

  <section>
    <h4>Contents</h4>
    <div id="msg"></div>
    <table>
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="size">Size</th>
          <th class="time">Uploaded</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <footer>API: <code>https://api.nock.ezpz.sh</code></footer>
</section>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = id => document.getElementById(id);

/* ---------- token + gate ---------- */
const getToken = () => (localStorage.getItem('token') || '').trim();
const setToken = (t) => localStorage.setItem('token', (t||'').trim());

async function verifyToken(t){
  const res = await fetch(`${API}/auth/verify`, { headers: t ? { Authorization: 'Bearer ' + t } : {} });
  if (!res.ok) return null;
  try { return await res.json(); } catch { return null; } // { roles, prefixes, writePrefixes }
}

function renderChips(prefixes){
  const wrap = $('chipsWrap'), c = $('chips');
  c.innerHTML = '';
  const list = (prefixes || []);
  if (!list.length) { wrap.classList.add('hidden'); return; }
  wrap.classList.remove('hidden');
  list.forEach(p => {
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.className = 'chip';
    chip.textContent = p;
    chip.onclick = () => { $('prefix').value = p.replace(/\/$/, ''); $('listBtn').click(); };
    c.appendChild(chip);
  });
}

async function enterWithToken(t){
  const info = await verifyToken(t);
  if (!info) return false;
  setToken(t);
  $('gate').classList.add('hidden');
  $('app').classList.remove('hidden');
  renderChips(info.writePrefixes || []);
  // Auto-list: prefer first writable, else first readable
  const first = (info.writePrefixes && info.writePrefixes[0]) || (info.prefixes && info.prefixes[0]);
  if (first) {
    $('prefix').value = first.replace(/\/$/, '');
    $('listBtn').click();
  }
  return true;
}

$('gateBtn').onclick = async () => {
  const t = $('gateToken').value.trim();
  const ok = await enterWithToken(t);
  $('gateToken').classList.toggle('invalid', !ok);
  $('gateMsg').textContent = ok ? '' : 'Invalid token';
};

// auto-try saved token
(async () => { const saved = getToken(); if (saved) await enterWithToken(saved); })();

/* ---------- helpers ---------- */
function authHeaders(){ const t=getToken(); return t ? { Authorization: 'Bearer ' + t } : {}; }
function normPrefix(p){ return p && !p.endsWith('/') ? p + '/' : p; }
function setMsg(txt, ok=true){ const el=$('msg'); el.textContent = txt || ''; el.style.color = ok ? '#444' : '#c33'; }

/* ---------- list (flat/recursive) ---------- */
$('listBtn').onclick = async () => {
  let prefix = normPrefix($('prefix').value.trim());
  if (!prefix) { alert('Enter a prefix'); return; }
  try {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', prefix);
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) { setMsg(`List failed (${res.status}):\n${await res.text()}`, false); return; }
    const data = await res.json(); // { prefix, objects }
    const rows = $('rows'); rows.innerHTML = '';
    if (!data.objects || data.objects.length === 0) { setMsg('No files.'); return; }
    setMsg('');

    for (const o of data.objects) {
      // Show relative name for readability
      const rel   = o.key.startsWith(prefix) ? o.key.slice(prefix.length) : o.key;
      const isPub = prefix.startsWith('pub/');
      const token = getToken();

      // Download: keep full priv path; strip leading 'priv/' for API route
      const dlKey = isPub ? rel : o.key.replace(/^priv\//, '');
      const encDlKey = dlKey.split('/').map(encodeURIComponent).join('/');

      const getHref = isPub
        ? `${API}/pub/${encDlKey}`
        : `${API}/priv/${encDlKey}?key=${encodeURIComponent(token)}`;

      const a   = `<a href="${getHref}" ${isPub ? '' : 'target="_blank"'}>GET</a>`;
      const del = isPub ? '' : ` <button data-key="${o.key}">DEL</button>`;

      rows.insertAdjacentHTML('beforeend',
        `<tr>
          <td class="name">${rel}</td>
          <td class="size">${o.size}</td>
          <td class="time">${new Date(o.uploaded).toLocaleString()}</td>
          <td class="actions">${a}${del}</td>
        </tr>`);
    }

    // delete (priv only)
    document.querySelectorAll('button[data-key]').forEach(btn => btn.onclick = async () => {
      if (!confirm('Delete ' + btn.dataset.key + '?')) return;
      const path = btn.dataset.key.replace(/^priv\//, '');
      const enc = path.split('/').map(encodeURIComponent).join('/');
      const resDel = await fetch(`${API}/priv/${enc}`, { method:'DELETE', headers: authHeaders() });
      if (!resDel.ok) setMsg('Delete failed: ' + (await resDel.text()), false);
      else $('listBtn').click();
    });
  } catch(e) { setMsg('List error: ' + (e?.message || e), false); }
};

/* ---------- upload ---------- */
$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.replace(/^priv\//, '');
  try {
    const enc = rel.split('/').map(encodeURIComponent).join('/');
    const res = await fetch(`${API}/priv/${enc}`, {
      method:'PUT',
      body:file,
      headers:{ ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else setMsg('Uploaded');
  } catch(e) { setMsg('Upload error: ' + (e?.message || e), false); }
};
</script>
</body>
</html>
