<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>nock files</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    :root {
      --maxw: 880px;
      --pad: 1.25rem;
    }
    body { max-width: var(--maxw); margin: 2rem auto; padding: 0 var(--pad); }
    header .row, nav.row, .row { display:flex; gap:.75rem; align-items:center; }
    input[type="password"], input[type="text"], input[type="file"], button { height: 2.25rem; }
    #msg { white-space: pre-wrap; font-size: .9rem; color: var(--muted-color); margin:.5rem 0 1rem; }
    table { border-collapse: separate; border-spacing:0; width:100%; overflow:hidden; border-radius:12px; }
    thead th { font-weight:600; background: hsl(0 0% 97%); position:sticky; top:0; }
    tbody tr:nth-child(even) { background: hsl(0 0% 98%); }
    tbody tr:hover { background: hsl(0 0% 95%); }
    td, th { padding:.6rem .75rem; }
    td.size, td.time { white-space: nowrap; }
    td.name { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    td.actions a, td.actions button { font-size:.9rem; }
    td.actions a { text-decoration: none; border-bottom: 1px dotted currentColor; }
    td.actions button { padding:.25rem .5rem; border-radius: 8px; }
    @media (prefers-color-scheme: dark) {
      thead th { background: hsl(0 0% 16%); }
      tbody tr:nth-child(even) { background: hsl(0 0% 12%); }
      tbody tr:hover { background: hsl(0 0% 18%); }
    }
  </style>
</head>
<body>
  <header class="row">
    <h2 style="flex:1">nock files</h2>
    <input id="token" type="password" placeholder="optional token" />
    <button id="saveToken">Save</button>
  </header>

  <nav class="row">
    <input id="prefix" style="flex:1" placeholder="pub" />
    <button id="listBtn">List</button>
  </nav>

  <article>
    <details open>
      <summary>Upload</summary>
      <div class="row">
        <input id="uploadPath" placeholder="priv/team-a/file.txt" style="flex:1" />
        <input id="fileInput" type="file" />
        <button id="uploadBtn">PUT</button>
      </div>
    </details>
  </article>

  <article>
    <h4>Contents</h4>
    <div id="msg"></div>
    <table>
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="size">Size</th>
          <th class="time">Uploaded</th>
          <th class="actions">Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </article>

  <footer>
    <small>API: <code>https://api.nock.ezpz.sh</code></small>
  </footer>

<script>
const API = 'https://api.nock.ezpz.sh';
const $ = (id) => document.getElementById(id);

// Token persistence
(function() {
  const t = localStorage.getItem('token') || '';
  $('token').value = t;
})();
$('saveToken').onclick = () => localStorage.setItem('token', $('token').value.trim());

function authHeaders() {
  const t = $('token').value.trim();
  return t ? { 'Authorization': 'Bearer ' + t } : {};
}

function normPrefix(p) {
  if (!p) return p;
  if (!p.endsWith('/')) p += '/';
  return p;
}

function setMsg(text, ok=true) {
  const el = $('msg');
  el.textContent = text || '';
  el.style.color = ok ? 'inherit' : 'var(--del-color, #c00)';
}

$('listBtn').onclick = async () => {
  let prefix = normPrefix($('prefix').value.trim());
  if (!prefix) { alert('Enter a prefix'); return; }
  try {
    const url = new URL(API + '/ls');
    url.searchParams.set('prefix', prefix.replace(/^pub\//, 'pub/').replace(/^priv\//, 'priv/'));
    const res = await fetch(url, { headers: authHeaders() });
    if (!res.ok) {
      const body = await res.text();
      setMsg(`List failed (status ${res.status}).\n${body}`, false);
      return;
    }
    const data = await res.json();
    const rows = $('rows'); rows.innerHTML = '';
    setMsg('');

    for (const d of data.directories) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="name"><strong>${d}</strong></td><td></td><td></td><td></td>`;
      rows.appendChild(tr);
    }
    for (const o of data.objects) {
      const rel   = o.key.startsWith(prefix) ? o.key.slice(prefix.length) : o.key;
      const isPub = prefix.startsWith('pub/');
      const token = $('token').value.trim();
      const getHref = isPub
        ? `${API}/pub/${rel.split('/').map(encodeURIComponent).join('/')}`
        : `${API}/priv/${rel.split('/').map(encodeURIComponent).join('/')}?key=${encodeURIComponent(token)}`;
      const a   = `<a href="${getHref}" ${isPub ? '' : 'target="_blank" rel="noopener"'}>GET</a>`;
      const del = isPub ? '' : ` <button data-key="${o.key}">DEL</button>`;
      const tr  = document.createElement('tr');
      tr.innerHTML =
        `<td class="name">${rel}</td>
         <td class="size">${o.size}</td>
         <td class="time">${new Date(o.uploaded).toLocaleString()}</td>
         <td class="actions">${a}${del}</td>`;
      rows.appendChild(tr);
    }

    // Wire delete buttons
    document.querySelectorAll('button[data-key]').forEach(btn => btn.onclick = async () => {
      const key = btn.getAttribute('data-key');
      if (!confirm('Delete ' + key + '?')) return;
      const path = key.startsWith('priv/') ? key.slice('priv/'.length) : key;
      const encodedPath = path.split('/').map(encodeURIComponent).join('/');
      const res = await fetch(`${API}/priv/${encodedPath}`, { method:'DELETE', headers: authHeaders() });
      if (!res.ok) setMsg('Delete failed: ' + (await res.text()), false);
      else $('listBtn').click();
    });
  } catch (e) {
    setMsg('List error: ' + (e && e.message ? e.message : e), false);
  }
};

$('uploadBtn').onclick = async () => {
  const file = $('fileInput').files[0];
  const target = $('uploadPath').value.trim();
  if (!file || !target) { alert('Pick file and target path'); return; }
  const rel = target.startsWith('priv/') ? target.slice('priv/'.length) : target;
  try {
    const res = await fetch(`${API}/priv/${rel.split('/').map(encodeURIComponent).join('/')}`, {
      method: 'PUT', body: file, headers: { ...authHeaders(), 'Content-Type': file.type || 'application/octet-stream' }
    });
    if (!res.ok) setMsg('Upload failed: ' + (await res.text()), false);
    else setMsg('Uploaded');
  } catch (e) {
    setMsg('Upload error: ' + (e && e.message ? e.message : e), false);
  }
};
</script>
</body>
</html>
